{% extends 'layout.html' %}

{% block head %}
{% parent %}
<script type="text/javascript" src="/js/d3.min.js"></script>
<script type="text/javascript">
  
  var playing = false;
  var repeat = false;
  var cellmasks;
  var cellmasks_width;
  var cellmask_row;
  var contrast = "{{ options[0] }}";
  var canvas_image, canvas_cells;
  var context_image, context_cells;
  var frameID = "000";
  var project_path = "{{ path }}";
  var cellmasks = project_path+"frames/";
  var images = project_path+"images/";
  var maximalFrames = parseInt("{{ maximalFrames }}");
  var currentFrameMasks;
  var animationSpeed = 25;
  var boundingboxes = [];
  var cellsizes = [];
  var selectedCells = [];
  var cells;

  function readMask() {
    $.get(cellmasks+"frame"+frameID+".json", function(data) {
      
        cells = data.cells;
        refreshBoundingBoxes(cells);

        currentFrameMasks = [];
        cellsizes = [];

        for(var i=0; i <= cells.length-1; i++){
          refreshMask(cells[i]);
          getCellSize(cells[i]);
        }
        
        generateGaussian();
        drawStats();

        updateCellmasks();
    });
  }

  function generateGaussian(){
    cellsizes.sort(function(a,b){return a-b});
  }

  function base64toBinary(base64Data) {
    var byteCharacters = atob(base64Data);
    var bytesLength = byteCharacters.length;

    var byteArray = [];

    for (var currentChar = 0; currentChar < bytesLength; ++currentChar) {
      var decodedChar = byteCharacters.charCodeAt(currentChar);
      for(var i = 0; i < 8; i++) {
        byteArray.push(fillString(decodedChar.toString(2),8).charAt(i));
      }
    }

    return byteArray;
  }

  function refreshMask(cell) {
    if(cell.mask != null) {
      currentFrameMasks.push(base64toBinary(cell.mask, 'binary'));
    }
    else {
      currentFrameMasks.push("empty");
    }
  }

  function UpdateNewFrame() {
    $.get(project_path+"paths.json", function(path) {
      var nextFrameSelectedCellIds = [];
      $.each(selectedCells, function(index, value) {
        var id = cells[value].path;

        var frame = parseInt(frameID);

        var hash = {};
        var pathIndex;
        for(var i = 0 ; i < path.paths[id].cells.length; i += 1) {
            hash[path.paths[id].cells[i]] = i;
        }

        var val = [parseInt(cells[value].id), frame-1];

        if(hash.hasOwnProperty(val)) {
          pathIndex = hash[val]+1
        }
        else {
          pathIndex = -1;
        }

        if(path.paths[id].cells[pathIndex]) {
          nextFrameSelectedCellIds.push(path.paths[id].cells[pathIndex][0]);
        }
        else if(path.paths[id].successors.length > 0){
          for(var i = 0; i <= path.paths[id].successors.length-1; i++) {
            var successor = path.paths[id].successors[i];
            nextFrameSelectedCellIds.push(path.paths[successor].cells[0][0].toString());
          }
        }
      });

      selectedCells = nextFrameSelectedCellIds;
      readMask(); 
      
    });
  }

  function updateCellmasks() {
    context_cells.clearRect(0,0,canvas_cells.width, canvas_cells.height);

    for(var i = 0; i <= selectedCells.length-1; i++) {
      drawMask(selectedCells[i]);
    }
  }


  function toggleCellSelection(cell_id) {
    if(cellIsSelected(cell_id)) {
      clearMask(cell_id);
      maskIndex = $.inArray(cell_id, selectedCells);
      selectedCells.splice(maskIndex, 1);
    }
    else {
      drawMask(cell_id);
      selectedCells.push(cell_id);
    }
  }

  function cellIsSelected(cell_id) {
    if($.inArray(cell_id, selectedCells) != -1)
      return true;
    else
      return false;
  }

  function clearMask(cell_id) {
    context_cells.clearRect(boundingboxes[cell_id].x-(boundingboxes[cell_id].width/2),boundingboxes[cell_id].y-(boundingboxes[cell_id].height/2),boundingboxes[cell_id].width, boundingboxes[cell_id].height);
  }

  function drawMask(cell_id) {
    var cellmask = currentFrameMasks[cell_id];
    var boxPosX = boundingboxes[cell_id].x-(boundingboxes[cell_id].width/2);
    var boxPosY = boundingboxes[cell_id].y-(boundingboxes[cell_id].height/2);
    
    var pixelPosX = 0, 
        pixelPosY = 0;
    for (var i = 0; i <= cellmask.length-1; i++) {

      if(pixelPosY >= boundingboxes[cell_id].height){
        pixelPosY = 0;
        pixelPosX++;
      }
      else {
        pixelPosY++;
      }

      if(cellmask[i] === "1"){
        context_cells.fillStyle = 'rgba(0,225,0,1)';
        context_cells.fillRect(pixelPosX+boxPosX-1, pixelPosY+boxPosY-1,1,1);
      } 

    }
  }

  function getCellSize(cell) {
    if(cell.id != null){
      var cellmask = currentFrameMasks[cell.id];
      var cellsizeInPixel = 0;

      for (var i = 0; i <= cellmask.length-1; i++) {
        if(cellmask[i] === "1"){
          cellsizeInPixel++
        } 
      }

      if(cellsizeInPixel != 0) {
        cellsizes.push(cellsizeInPixel);
      }
    }
  }

  function refreshBoundingBoxes(nextCells) {
    boundingboxes = [];
    for (var i = 0; i <= nextCells.length-1; i++) {
        var box;
      if(nextCells[i].id == null) {
        box = {}
      }
      else {
        box = {};
        box.id = nextCells[i].id;
        box.x = nextCells[i].centroid.y;
        box.y = nextCells[i].centroid.x;
        box.height =  nextCells[i].boundingbox.xr - nextCells[i].boundingbox.xl;
        box.width =  nextCells[i].boundingbox.yr - nextCells[i].boundingbox.yl;  
      }
      boundingboxes.push(box);
    }
    drawBoundingBoxes();
  }

  function drawBoundingBoxes() {
    for (var i = 0; i <= boundingboxes.length-1; i++) {
      if(boundingboxes[i].id != null) {
        context_cells.fillStyle = 'rgba(0,225,0,1)';
        context_cells.fillRect(boundingboxes[i].x-(boundingboxes[i].width/2),boundingboxes[i].y-(boundingboxes[i].height/2),boundingboxes[i].width, boundingboxes[i].height);
      }
    }
  }

  function selectCanvasElements(event) {
      
      var posX = parseInt ($("#celltrack_canvas_cells").offset().left);
      var posY = parseInt ($("#celltrack_canvas_cells").offset().top);

      var mouseX = parseInt (event.pageX) - posX;
      var mouseY = parseInt (event.pageY) - posY;

      mouseX = mouseX*(canvas_image.width/$("#celltrack_canvas_image").width());
      mouseY = mouseY*(canvas_image.height/$("#celltrack_canvas_image").height());
      
    for (var i = 0; i <= boundingboxes.length-1; i++) {
      var boxWidth = boundingboxes[i].width;
      var boxHeight = boundingboxes[i].height;
      var boxPositionX = boundingboxes[i].x-(boundingboxes[i].width/2);
      var boxPositionY = boundingboxes[i].y-(boundingboxes[i].height/2);

      if(mouseX >= boxPositionX && mouseX <= boxPositionX+boxWidth) {
        if(mouseY >= boxPositionY && mouseY <= boxPositionY+boxHeight) {
          toggleCellSelection(boundingboxes[i].id);
        }
      }

    };
  }

  function toggleRepeat() {
    if(repeat)
      repeat = false;
    else 
      repeat = true;
  }

  function fillString(value, maximum) {
    while (value.length < maximum) value = '0' + value;
    return value;
  }

  function play(){
    if(playing) {
      newframeID = parseInt(frameID)+1;

      if(newframeID >= maximalFrames){
        newframeID = 0;
        if(!repeat) {
          playing = false;
          $("#playButton").toggleClass( "active red" );
          $("#playIcon").toggleClass( "hidden" );
          $("#pauseIcon").toggleClass( "hidden" );
        }
      }

      progress = (newframeID/maximalFrames)*100;

      $("#progress").width(progress+"%");

      frameID = fillString(newframeID.toString(),3);

      var image = new Image();
      image.src = images+contrast+"/"+"frame"+frameID+".png";

      image.onload = function() {
        canvas_image.width  = image.width;
        canvas_image.height = image.height;
        canvas_image.style.width  = '75%';

        context_image.drawImage(image, 0, 0);

        UpdateNewFrame();
      }
    }
      window.setTimeout(play, (1/animationSpeed)*5000);
  }

  $( document ).ready(function() {

    $('.ui.selection.dropdown')
      .dropdown()
    ;

    $(".contrast").click(function () {
      contrast = $("#contrast").val();
      var image = new Image();
      image.src = images+contrast+"/"+"frame"+frameID+".png";
      image.onload = function() {
        canvas_image.width  = image.width;
        canvas_image.height = image.height;
        canvas_image.style.width  = '75%';
        context_image.drawImage(image, 0, 0);
      }      
    });

    $("#playButton").click(function() {

      $("#playButton").toggleClass( "active red" );
      $("#playIcon").toggleClass( "hidden" );
      $("#pauseIcon").toggleClass( "hidden" );

      if(!playing)
        playing = true;
      else 
        playing = false;
    });

    $("#repeatButton").click(function() {

      $("#repeatButton").toggleClass( "active red" );

      if(!repeat)
        repeat = true;
      else 
        repeat = false;
    });

    canvas_image = document.getElementById('celltrack_canvas_image');
    canvas_cells = document.getElementById('celltrack_canvas_cells');

    $("#celltrack_canvas_cells").click(selectCanvasElements);
    
    context_image = canvas_image.getContext('2d');
    context_cells = canvas_cells.getContext('2d');

    var image = new Image();
    image.src = images+contrast+"/"+"frame"+frameID+".png";

    image.onload = function() {
      canvas_image.width  = image.width;
      canvas_image.height = image.height;
      canvas_image.style.width  = '75%';

      canvas_cells.width  = image.width;
      canvas_cells.height = image.height;
      canvas_cells.style.width  = '75%';
  
      context_image.drawImage(image, 0, 0);

      document.getElementById("canvasContainer").style.height = $("#celltrack_canvas_cells").height().toString()+"px";
    }
    readMask();
    play();
  });

  $( window ).resize(function() {
    document.getElementById("canvasContainer").style.height = $("#celltrack_canvas_cells").height().toString()+"px";
  });


  function drawStats() { 
    var m = [80, 80, 80, 80];
    var w = 1000 - m[1] - m[3];
    var h = 400 - m[0] - m[2];
    
    var x = d3.scale.linear().domain([0, cellsizes.length]).range([0, w]);
    var y = d3.scale.linear().domain([0, Math.max.apply(Math, cellsizes)]).range([h, 0]);

    $( "#graph > svg" ).remove();

    var line = d3.svg.line()
      .x(function(d,i) { 
        return x(i); 
      })
      .y(function(d) { 
        return y(d); 
      })

      var graph = d3.select("#graph").append("svg:svg")
            .attr("width", w + m[1] + m[3])
            .attr("height", h + m[0] + m[2])
          .append("svg:g")
            .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

      var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
      graph.append("svg:g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + h + ")")
            .call(xAxis);

      graph.append("text")
              .attr("class", "axis-label")
              .attr("x", (w + m[1] + m[3])/(4/3))
              .attr("text-anchor", "middle")
              .attr("dy", (h + m[0] + m[2])-105)
              .attr("font-size", "1.2em")
              .attr("fill", "#4d77b0")
              .text("Number of cells");

      var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");
      graph.append("svg:g")
            .attr("class", "y axis")
            .attr("transform", "translate(-25,0)")
            .call(yAxisLeft)
            .append("text")
            .attr("class", "axis-label")
              .attr("y", -30)
              .attr("x", -30)
              .attr("font-size", "1.2em")
              .attr("fill", "#4d77b0")
              .style("text-anchor", "start")
              .text("Size in pixel");
            

      graph.append("svg:path").attr("d", line(cellsizes));
    } 

  </script>
{% endblock %}

{% block content %}
<div class="sixteen wide column">
    <div class="ui breadcrumb">
      <a class="section" href="/">Home</a>
      <div class="divider"> / </div>
      <div class="active section">{{ db_experiment.name }}</div>
    </div>
</div>
<h2 class="ui header">{{ db_experiment.name }}</h2>
<div class="ui divider"></div>
<div class="twelve wide column">
  <p class="ui large label"> {{ db_experiment.authors }} </p>
</div>
<div class="four wide column">
    <div class="ui selection dropdown">
      <input type="hidden" name="contrast" id="contrast">
      <div class="default text">Contrast variations</div>
      <i class="dropdown icon"></i>
      <div class="menu">
        {% for option in options %}
        <div class="contrast item" data-value="{{ option }}">{{ option }}</div>
        {% endfor %}
      </div>
    </div>
</div>
<div class="twelve wide column">
      <div id="canvasContainer">
        <canvas id="celltrack_canvas_image" class="celltrack_canvas" style="position: absolute; z-index: 0">Sorry, your browser cannot display this image. Download and install the latest version of
        your favorite browser and try it again.</canvas>
        <canvas id="celltrack_canvas_cells" class="celltrack_canvas" style="position: absolute; z-index: 1">Sorry, your browser cannot display this image. Download and install the latest version of
        your favorite browser and try it again.</canvas>
      </div>
</div>
<div class="four wide column">
  <div class="ui red inverted segment">
    <h2>Description</h2>
    <p>{{ db_experiment.description }}</p>
  </div>
</div>

<div class="sixteen wide column">
  <div class="ui progress">
    <div id="progress" class="notransition bar" style="width: 0%;"></div>
  </div>
</div>

<div id="buttonmenu" class="ui icon buttons">
  <div id="playButton" class="huge ui toggle button">
    <i id="playIcon" class="play icon"></i>
    <i id="pauseIcon" class="hidden pause icon"></i>
  </div>
  <div class="huge ui button">
    <i class="step backward icon"></i>
  </div>
    <div class="huge ui button">
    <i class="step forward icon"></i>
  </div>
  <div class="huge ui button">
    <i class="stop icon"></i>
  </div>
  <div id="repeatButton" class="huge ui toggle button">
    <i class="repeat icon"></i>
  </div>
</div>

<h3 class="ui header">Statistics</h3>
<div class="ui divider"></div>

<div class="sixteen wide column">
  <div class="ui tabular menu">
    <a class="active item">
      Cell size
    </a>
  </div>
  <div id="graph" class="aGraph"></div>
</div>
{% endblock %}